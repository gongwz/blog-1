<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Sentry是一个开源的程序异常跟踪系统，基本上主流的语言，Sentry都支持，Sentry是用Django+DRF+Celery+Celery-Beat开发的，如果你是Pythoner，并且对这些技术栈都相当熟悉，你可以阅读一下相关的源码，定有不少的收获，这里值得一提的是Sentry在部署的时候只支持Python2，不支持Python3。 这篇文章我们将会以Docker的方式部署Sentry，这">
<meta name="keywords" content="安生,Python">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker部署Sentry监控Django应用并使用email+钉钉通知">
<meta property="og:url" content="https://blog.ansheng.me/article/docker-sentry-django-email-dingtalk/index.html">
<meta property="og:site_name" content="Welcome to ansheng’s blog!">
<meta property="og:description" content="Sentry是一个开源的程序异常跟踪系统，基本上主流的语言，Sentry都支持，Sentry是用Django+DRF+Celery+Celery-Beat开发的，如果你是Pythoner，并且对这些技术栈都相当熟悉，你可以阅读一下相关的源码，定有不少的收获，这里值得一提的是Sentry在部署的时候只支持Python2，不支持Python3。 这篇文章我们将会以Docker的方式部署Sentry，这">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531814821978851.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531814926463487.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815010037154.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815044620126.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815081686595.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/153181512463147.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815155343037.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/153181519029878.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/15318152279307442.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/15318152560393028.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/15318152873324091.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/15318153344064908.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/15318153599131148.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/15318154003174138.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815423369428.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815451551609.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815482810024.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815509278548.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815528549936.png">
<meta property="og:image" content="https://blog.ansheng.me/images/2018/07/1531815564221066.png">
<meta property="og:updated_time" content="2018-07-27T03:26:40.064Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Docker部署Sentry监控Django应用并使用email+钉钉通知">
<meta name="twitter:description" content="Sentry是一个开源的程序异常跟踪系统，基本上主流的语言，Sentry都支持，Sentry是用Django+DRF+Celery+Celery-Beat开发的，如果你是Pythoner，并且对这些技术栈都相当熟悉，你可以阅读一下相关的源码，定有不少的收获，这里值得一提的是Sentry在部署的时候只支持Python2，不支持Python3。 这篇文章我们将会以Docker的方式部署Sentry，这">
<meta name="twitter:image" content="https://blog.ansheng.me/images/2018/07/1531814821978851.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
          
        
    
    <!-- title -->
    <title>Docker部署Sentry监控Django应用并使用email+钉钉通知</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg active"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg active"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="//notes.ansheng.me">Notes</a></li>
         
          <li><a href="/article/python-full-stack-way/">PythonFullStackWay</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/article/python-data-structure-and-algorithm-series-selection-sort/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/article/centos-ngrok-intranet-penetration/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境"><span class="toc-number">1.</span> <span class="toc-text">环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化操作"><span class="toc-number">1.1.</span> <span class="toc-text">初始化操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本配置"><span class="toc-number">1.2.</span> <span class="toc-text">基本配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Docker"><span class="toc-number">2.</span> <span class="toc-text">安装Docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装docker-compose"><span class="toc-number">3.</span> <span class="toc-text">安装docker-compose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Sentry"><span class="toc-number">4.</span> <span class="toc-text">安装Sentry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentry的基本设置"><span class="toc-number">5.</span> <span class="toc-text">Sentry的基本设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#添加一个Python项目"><span class="toc-number">5.1.</span> <span class="toc-text">添加一个Python项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#测试Python程序"><span class="toc-number">5.1.1.</span> <span class="toc-text">测试Python程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看异常"><span class="toc-number">5.1.2.</span> <span class="toc-text">查看异常</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加Django项目并进行监控"><span class="toc-number">6.</span> <span class="toc-text">添加Django项目并进行监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建django项目"><span class="toc-number">6.1.</span> <span class="toc-text">创建django项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集成Sentry"><span class="toc-number">6.2.</span> <span class="toc-text">集成Sentry</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置email通知"><span class="toc-number">7.</span> <span class="toc-text">配置email通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置钉钉通知"><span class="toc-number">8.</span> <span class="toc-text">配置钉钉通知</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Docker部署Sentry监控Django应用并使用email+钉钉通知
    </h1>



    <div class="meta">
      <span class="postdate">创建日期：</span>
    <div class="postdate">
        <time datetime="2018-07-16T16:00:00.000Z" itemprop="datePublished">2018-07-17</time>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Sentry是一个开源的程序异常跟踪系统，基本上主流的语言，Sentry都支持，Sentry是用<code>Django+DRF+Celery+Celery-Beat</code>开发的，如果你是<code>Pythoner</code>，并且对这些技术栈都相当熟悉，你可以阅读一下相关的源码，定有不少的收获，这里值得一提的是<code>Sentry</code>在部署的时候只支持<code>Python2</code>，不支持<code>Python3</code>。</p>
<p>这篇文章我们将会以<code>Docker</code>的方式部署<code>Sentry</code>，这也是官方推荐的部署方式，并且我们会写一个简单的<code>Django</code>应用，使用<code>email+钉钉</code>的方式进行通知，一旦出现异常，开发人员可以及时收到并处理。</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>我在<code>vultr</code>上开了一台云服务器供这次测试使用，用的是<code>CentOS7</code>的系统。</p>
<h3 id="初始化操作"><a href="#初始化操作" class="headerlink" title="初始化操作"></a>初始化操作</h3><p>安装epel源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install epel-release -y</span><br></pre></td></tr></table></figure>
<p>更新系统</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum update -y</span><br></pre></td></tr></table></figure>
<p>安装一些工具包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install python-pip vim git -y</span><br></pre></td></tr></table></figure>
<p>建议重启下系统</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ reboot</span><br></pre></td></tr></table></figure>
<h3 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h3><ul>
<li>内存</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           3.7G         95M        3.4G        8.4M        168M        3.4G</span><br><span class="line">Swap:            0B          0B          0B</span><br></pre></td></tr></table></figure>
<ul>
<li>CPU</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /proc/cpuinfo | grep processor | wc -l</span><br><span class="line">2</span><br></pre></td></tr></table></figure>
<p>配置也就是<code>2H4G</code>，如果你是<code>1G</code>内存的服务器，貌似我在腾讯云上面跑起来比较艰难，感觉至少还是要<code>2G</code>把。</p>
<h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><p>CentOS系列的安装文档放在：<a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/centos/</a> ，感兴趣的就可以去阅读，我这里就简化一些操作。</p>
<ul>
<li>安装一些软件包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>
<ul>
<li>添加docker的repo源</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
<ul>
<li>安装docker</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ yum install docker-ce -y</span><br></pre></td></tr></table></figure>
<ul>
<li>启动docker</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl start docker</span><br></pre></td></tr></table></figure>
<ul>
<li>开机自启动</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>
<ul>
<li>查看docker版本</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker --version</span><br><span class="line">Docker version 18.03.1-ce, build 9ee9f40</span><br></pre></td></tr></table></figure>
<ul>
<li>运行一个<code>hello-world</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run hello-world</span><br><span class="line">Unable to find image <span class="string">'hello-world:latest'</span> locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">9db2ca6ccae0: Pull complete</span><br><span class="line">Digest: sha256:4b8ff392a12ed9ea17784bd3c9a8b1fa3299cac44aca35a85c90c5e3c7afacdc</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"> 1. The Docker client contacted the Docker daemon.</span><br><span class="line"> 2. The Docker daemon pulled the <span class="string">"hello-world"</span> image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"> 3. The Docker daemon created a new container from that image <span class="built_in">which</span> runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> 4. The Docker daemon streamed that output to the Docker client, <span class="built_in">which</span> sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"> $ docker run -it ubuntu bash</span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/engine/userguide/</span><br></pre></td></tr></table></figure>
<p>如果你运行之后出现的结果和我一样，那么，OK，docker已经安装完成了.</p>
<p>如果你使用的是国内的服务器，可能在<code>pull</code>镜像的时候，异常的慢，所以官方就提供了国内的docker镜像加速，<a href="http://docker-cn.com/registry-mirror" target="_blank" rel="noopener">点我点我</a>，配置好之后一定要记得重启下docker的服务，不然无法加载配置，重启命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl restart docker</span><br></pre></td></tr></table></figure>
<h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-`uname -s`-`uname -m` -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>我装的是<code>1.21.2</code>版本，通常你安装的<code>docker</code>和<code>docker-compose</code>是最新的版本都不会有什么问题，查看一下<code>docker-compose</code>版本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker-compose --version</span><br><span class="line">docker-compose version 1.21.2, build a133471</span><br></pre></td></tr></table></figure>
<h2 id="安装Sentry"><a href="#安装Sentry" class="headerlink" title="安装Sentry"></a>安装Sentry</h2><p>终于到了关键的步骤，<code>Sentry</code>，官方提供了一整套<code>docker</code>的部署方式来运行<code>Sentry</code>。</p>
<ul>
<li>下载项目</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/getsentry/onpremise.git sentry</span><br><span class="line">$ <span class="built_in">cd</span> sentry</span><br></pre></td></tr></table></figure>
<ul>
<li>创建数据库和Sentry配置目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir -p data/&#123;sentry,postgres&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>添加一些依赖库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim requirements.txt</span><br><span class="line"><span class="comment"># Add plugins here</span></span><br><span class="line">sentry-dingding~=0.0.1  <span class="comment"># 钉钉通知插件 </span></span><br><span class="line">django-smtp-ssl~=1.0  <span class="comment"># 发邮件支持SSL协议</span></span><br></pre></td></tr></table></figure>
<ul>
<li>构建Docker镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker-compose build</span><br></pre></td></tr></table></figure>
<ul>
<li>生成密钥</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker-compose run --rm web config generate-secret-key</span><br><span class="line">......</span><br><span class="line"><span class="comment"># 最后一行会输出类似如下的秘钥串</span></span><br><span class="line">kbjodp(id&amp;b0^kbnxijn11&amp;2e6xu&amp;vy1(oini!-zl)pl610n&amp;v</span><br></pre></td></tr></table></figure>
<p>把上面的秘钥添加到<code>docker-compose.yml</code>文件的<code>SENTRY_SECRET_KEY</code>环境变量中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim docker-compose.yml</span><br><span class="line">......</span><br><span class="line">SENTRY_SECRET_KEY: <span class="string">'kbjodp(id&amp;b0^kbnxijn11&amp;2e6xu&amp;vy1(oini!-zl)pl610n&amp;v'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>生成数据库表并创建管理员用户</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker-compose run --rm web upgrade</span><br><span class="line">......</span><br><span class="line">Would you like to create a user account now? [Y/n]: y  <span class="comment"># 创建用户</span></span><br><span class="line">Email: ianshengme@gmail.com  <span class="comment"># 邮箱</span></span><br><span class="line">Password:  <span class="comment"># 密码</span></span><br><span class="line">Repeat <span class="keyword">for</span> confirmation:  <span class="comment"># 确认密码</span></span><br><span class="line">Should this user be a superuser? [y/N]: y  <span class="comment"># 为超级管理员用户</span></span><br></pre></td></tr></table></figure>
<ul>
<li>启动服务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>可以通过<code>docker-compose ps</code>查看一下启动了那些容器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker-compose ps</span><br><span class="line">       Name                     Command               State           Ports</span><br><span class="line">------------------------------------------------------------------------------------</span><br><span class="line">sentry_cron_1        /entrypoint.sh run cron          Up      9000/tcp</span><br><span class="line">sentry_memcached_1   docker-entrypoint.sh memcached   Up      11211/tcp</span><br><span class="line">sentry_postgres_1    docker-entrypoint.sh postgres    Up      5432/tcp</span><br><span class="line">sentry_redis_1       docker-entrypoint.sh redis ...   Up      6379/tcp</span><br><span class="line">sentry_smtp_1        docker-entrypoint.sh tini  ...   Up      25/tcp</span><br><span class="line">sentry_web_1         /entrypoint.sh run web           Up      0.0.0.0:9000-&gt;9000/tcp</span><br><span class="line">sentry_worker_1      /entrypoint.sh run worker        Up      9000/tcp</span><br></pre></td></tr></table></figure>
<p>上面的几个服务，介绍如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>sentry_cron</code></td>
<td style="text-align:left">定时任务，使用的是<code>celery-beat</code></td>
</tr>
<tr>
<td style="text-align:left"><code>sentry_memcached</code></td>
<td style="text-align:left">memcached</td>
</tr>
<tr>
<td style="text-align:left"><code>sentry_postgres</code></td>
<td style="text-align:left">pgsql数据库</td>
</tr>
<tr>
<td style="text-align:left"><code>sentry_redis</code></td>
<td style="text-align:left">运行celery需要的服务</td>
</tr>
<tr>
<td style="text-align:left"><code>sentry_smtp</code></td>
<td style="text-align:left">发邮件</td>
</tr>
<tr>
<td style="text-align:left"><code>sentry_web</code></td>
<td style="text-align:left">使用<code>django+drf</code>写的一套<code>Sentry Web界面</code></td>
</tr>
<tr>
<td style="text-align:left"><code>sentry_worker</code></td>
<td style="text-align:left">celery的worker服务，用来跑异步任务的</td>
</tr>
</tbody>
</table>
<p>服务启动之后，默认会监听<code>9000</code>端口，如果你想更改，可以在<code>docker-compose.yml</code>中进行更改。</p>
<p>我将我的域名<code>ansheng.me</code>添加了一条<code>A</code>记录，记录值是<code>sentry</code>，指向这台sentry的云服务器，所以可以通过<code>sentry.ansheng.me</code>进行访问。</p>
<h2 id="Sentry的基本设置"><a href="#Sentry的基本设置" class="headerlink" title="Sentry的基本设置"></a>Sentry的基本设置</h2><p>浏览器打开<code>http://sentry.ansheng.me:9000/</code>，输入邮箱和密码进行登录</p>
<p><img src="/images/2018/07/1531814821978851.png" alt="1531814821978851"></p>
<p>登录成功之后，输入对应的<code>Root URL</code>和<code>Admin Email</code>，然后点击<code>Continue</code></p>
<p><img src="/images/2018/07/1531814926463487.png" alt="1531814926463487"></p>
<p>点击之后就进入了<code>Sentry</code>的主界面</p>
<p><img src="/images/2018/07/1531815010037154.png" alt="1531815010037154"></p>
<h3 id="添加一个Python项目"><a href="#添加一个Python项目" class="headerlink" title="添加一个Python项目"></a>添加一个Python项目</h3><p>点击右上角的<code>Add new</code>，选择<code>Project</code></p>
<p><img src="/images/2018/07/1531815044620126.png" alt="1531815044620126"></p>
<p>然后创建项目</p>
<p><img src="/images/2018/07/1531815081686595.png" alt="1531815081686595"></p>
<p>项目创建完成之后，会出现一个使用的界面</p>
<p><img src="/images/2018/07/153181512463147.png" alt="153181512463147"></p>
<h4 id="测试Python程序"><a href="#测试Python程序" class="headerlink" title="测试Python程序"></a>测试Python程序</h4><p>按照上面的步骤 ，我们来一步一步的操作，我在我这台服务器上面操作，Python版本如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python -V</span><br><span class="line">Python 2.7.5</span><br></pre></td></tr></table></figure>
<ul>
<li>安装raven</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install raven --upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li>添加测试代码</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim sentry_python_test.py</span><br><span class="line">from raven import Client</span><br><span class="line"></span><br><span class="line">client = Client(<span class="string">'http://ce5502f746a4484f9b2c391a54d2d1c4:bca94f6b330a4dd183e68243b2a1b99c@sentry.ansheng.me:9000/2'</span>)</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    1 / 0</span><br><span class="line">except ZeroDivisionError:</span><br><span class="line">    client.captureException()</span><br></pre></td></tr></table></figure>
<ul>
<li>运行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python sentry_python_test.py</span><br><span class="line">Sentry is attempting to send 1 pending error messages</span><br><span class="line">Waiting up to 10 seconds</span><br><span class="line">Press Ctrl-C to quit</span><br></pre></td></tr></table></figure>
<h4 id="查看异常"><a href="#查看异常" class="headerlink" title="查看异常"></a>查看异常</h4><p>在上面的使用界面中，点击<code>Got it~ Take me to the Issue Stream.</code>进入到项目的<code>Issue</code>页面，也就是错误页面</p>
<p><img src="/images/2018/07/1531815155343037.png" alt="1531815155343037"></p>
<p>可以看到已经有一条异常了，这个异常就是我们刚测时捕获的报错，点击<code>ZeroDivisionError</code>大标题，进入异常的详细页面。</p>
<p>在项目页面中我们可以看到<code>MESSAGE</code>和<code>EXCEPTION</code>这两块，输出了具体的错误详情</p>
<p><img src="/images/2018/07/153181519029878.png" alt="153181519029878"></p>
<p>基本上的步骤就像上面一样，流程都差不多</p>
<h2 id="添加Django项目并进行监控"><a href="#添加Django项目并进行监控" class="headerlink" title="添加Django项目并进行监控"></a>添加Django项目并进行监控</h2><p>根据上面创建<code>Python</code>Sentry项目的步骤添加一个名为<code>cash</code>，是<code>Django</code>框架的项目，并把<code>DSN</code>的记录值保存下来</p>
<blockquote>
<p><a href="http://9ad8168873a94fb1927e14111b9bca1e:29ea550781e24ca2ba0c0ee4829dfc96@sentry.ansheng.me:9000/3" target="_blank" rel="noopener">http://9ad8168873a94fb1927e14111b9bca1e:29ea550781e24ca2ba0c0ee4829dfc96@sentry.ansheng.me:9000/3</a></p>
</blockquote>
<p><img src="/images/2018/07/15318152279307442.png" alt="15318152279307442"></p>
<h3 id="创建django项目"><a href="#创建django项目" class="headerlink" title="创建django项目"></a>创建django项目</h3><p>django的项目我在我的电脑上创建.</p>
<ul>
<li>添加一个名为<code>cash</code>的虚拟环境</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv virtualenv 3.6.5 cash</span><br></pre></td></tr></table></figure>
<ul>
<li>切换虚拟环境</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv activate cash</span><br></pre></td></tr></table></figure>
<ul>
<li>安装django</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install django</span><br></pre></td></tr></table></figure>
<ul>
<li>创建project</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /tmp</span><br><span class="line">$ django-admin startproject cash</span><br><span class="line">$ <span class="built_in">cd</span> cash</span><br><span class="line">$ python manage.py migrate</span><br></pre></td></tr></table></figure>
<ul>
<li>启动项目</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python manage.py runserver 0:9999</span><br><span class="line">Performing system checks...</span><br><span class="line"></span><br><span class="line">System check identified no issues (0 silenced).</span><br><span class="line">July 17, 2018 - 03:35:05</span><br><span class="line">Django version 2.0.7, using settings &apos;cash.settings&apos;</span><br><span class="line">Starting development server at http://0:9999/</span><br><span class="line">Quit the server with CONTROL-C.</span><br></pre></td></tr></table></figure>
<p>端口监听在<code>9999</code>，可以通过curl进行访问测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -I http://127.0.0.1:9999</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>状态是200表示运行没问题</p>
<ul>
<li>查看目录结构</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  cash tree ./</span><br><span class="line">./</span><br><span class="line">├── cash</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── settings.py</span><br><span class="line">│   ├── urls.py</span><br><span class="line">│   ├── views.py</span><br><span class="line">│   └── wsgi.py</span><br><span class="line">├── db.sqlite3</span><br><span class="line">└── manage.py</span><br></pre></td></tr></table></figure>
<ul>
<li>编写一个简单的views</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim cash/views.py</span><br><span class="line">from django.http import HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def success(request):</span><br><span class="line">    <span class="built_in">return</span> HttpResponse(<span class="string">"OK"</span>)</span><br><span class="line"></span><br><span class="line">def error(request):</span><br><span class="line">    1 / 0</span><br><span class="line">    <span class="built_in">return</span> HttpResponse(<span class="string">"Not OK"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>添加url</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim cash/urls.py</span><br><span class="line">from django.urls import path</span><br><span class="line"></span><br><span class="line">from . import views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'success'</span>, views.success, name=<span class="string">'success'</span>),</span><br><span class="line">    path(<span class="string">'error'</span>, views.error, name=<span class="string">'error'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>访问测试</li>
</ul>
<p>访问可以返回成功的API</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:9999/success</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p>访问会报错的API</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -I http://127.0.0.1:9999/error</span><br><span class="line">HTTP/1.1 500 Internal Server Error</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>报了一个<code>500</code>的错误，日志输出如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Internal Server Error: /error</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/Users/shengan/.pyenv/versions/cash/lib/python3.6/site-packages/django/core/handlers/exception.py&quot;, line 35, in inner</span><br><span class="line">    response = get_response(request)</span><br><span class="line">  File &quot;/Users/shengan/.pyenv/versions/cash/lib/python3.6/site-packages/django/core/handlers/base.py&quot;, line 128, in _get_response</span><br><span class="line">    response = self.process_exception_by_middleware(e, request)</span><br><span class="line">  File &quot;/Users/shengan/.pyenv/versions/cash/lib/python3.6/site-packages/django/core/handlers/base.py&quot;, line 126, in _get_response</span><br><span class="line">    response = wrapped_callback(request, *callback_args, **callback_kwargs)</span><br><span class="line">  File &quot;/private/tmp/cash/cash/views.py&quot;, line 8, in error</span><br><span class="line">    1 / 0</span><br><span class="line">ZeroDivisionError: division by zero</span><br><span class="line">[17/Jul/2018 03:50:55] &quot;HEAD /error HTTP/1.1&quot; 500 60675</span><br></pre></td></tr></table></figure>
<h3 id="集成Sentry"><a href="#集成Sentry" class="headerlink" title="集成Sentry"></a>集成Sentry</h3><ul>
<li>安装raven</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install raven --upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>INSTALLED_APPS</code>中添加<code>raven.contrib.django.raven_compat</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ......</span><br><span class="line">    <span class="string">'raven.contrib.django.raven_compat'</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>在setting内添加sentry配置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">import os</span><br><span class="line">import raven</span><br><span class="line"></span><br><span class="line">RAVEN_CONFIG = &#123;</span><br><span class="line">    <span class="string">'dsn'</span>: <span class="string">'http://9ad8168873a94fb1927e14111b9bca1e:29ea550781e24ca2ba0c0ee4829dfc96@sentry.ansheng.me:9000/3'</span>  <span class="comment"># DSN输入我们刚才记录下来的DSN</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>配置完成之后，我我们再来进行下测试</li>
</ul>
<p>访问错误的API</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -I http://127.0.0.1:9999/error</span><br></pre></td></tr></table></figure>
<ul>
<li>异常列表</li>
</ul>
<p><img src="/images/2018/07/15318152560393028.png" alt="15318152560393028"></p>
<ul>
<li>异常详情</li>
</ul>
<p><img src="/images/2018/07/15318152873324091.png" alt="15318152873324091"></p>
<h2 id="配置email通知"><a href="#配置email通知" class="headerlink" title="配置email通知"></a>配置email通知</h2><p>我这里使用的是网易邮箱，具体操作如下</p>
<ul>
<li>修改config.yml文件添加<code>Mail Server</code>的配置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim config.yml</span><br><span class="line">mail.backend: <span class="string">'django_smtp_ssl.SSLEmailBackend'</span>  <span class="comment"># Use dummy if you want to disable email entirely</span></span><br><span class="line">mail.host: <span class="string">'smtp.163.com'</span></span><br><span class="line">mail.port: 465</span><br><span class="line">mail.username: <span class="string">'anshengme@163.com'</span></span><br><span class="line">mail.password: <span class="string">'14RJg5vzGFWUNKiP'</span>  <span class="comment"># 这里的密码，不是登录密码，是"客户端授权密码"</span></span><br><span class="line">mail.use-tls: <span class="literal">false</span></span><br><span class="line"><span class="comment"># The email address to send on behalf of</span></span><br><span class="line">mail.from: <span class="string">'anshengme@163.com'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>重新build镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker-compose build</span><br><span class="line">$ docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>重启之后可以在<code>Admin</code>==&gt;<code>邮件</code>下面找到邮箱的配置</p>
<p><img src="/images/2018/07/15318153344064908.png" alt="15318153344064908"></p>
<p>然后点击下面的<code>向 ianshengme@gmail.com 发送一份测试邮件</code>，然后进入你的邮箱，查看是否收到了邮件</p>
<p><img src="/images/2018/07/15318153599131148.png" alt="15318153599131148"></p>
<p>我这里是可以成功收到发送过来的测试邮件，通常邮箱配置完成之后就可以接收到异常通知了。</p>
<ul>
<li>验证用户的邮箱</li>
</ul>
<p>找到<code>Settings=&gt;Account=&gt;Emails</code></p>
<p><img src="/images/2018/07/15318154003174138.png" alt="15318154003174138"></p>
<p>然后点击<code>Resend verification</code>，会收到一封验证邮件</p>
<p><img src="/images/2018/07/1531815423369428.png" alt="1531815423369428"></p>
<p>点击<code>Confirm</code>确认邮箱。</p>
<ul>
<li>异常通知测试</li>
</ul>
<p>然后呢，我们在访问一下错误的API</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -I http://127.0.0.1:9999/error</span><br><span class="line">HTTP/1.1 500 Internal Server Error</span><br></pre></td></tr></table></figure>
<ul>
<li>查看邮箱收到的报警邮件</li>
</ul>
<p><img src="/images/2018/07/1531815451551609.png" alt="1531815451551609"></p>
<p>基本上你收到的错误邮件就和上面的差不多，不知道为什么那个头像不显示，不管它，如果你要查看错误详情，点击<code>View on Sentry</code>就可以打开异常详情了。</p>
<h2 id="配置钉钉通知"><a href="#配置钉钉通知" class="headerlink" title="配置钉钉通知"></a>配置钉钉通知</h2><p>我们都知道，邮箱通知的时效性太差，不能够即使传递，所以我们重点介绍下<code>钉钉机器人</code>的群通知。</p>
<ul>
<li>创建钉钉群组添加自定义机器人并获取到<code>access_token</code></li>
</ul>
<p>我这里获取到的<code>access_token</code>是<code>4dadfa77dfc3fe3b34e91237665afbef165e745dd93ec191c48bf4843b1ad63c</code></p>
<ul>
<li>配置</li>
</ul>
<p>找到cash项目的所有集成</p>
<p><img src="/images/2018/07/1531815482810024.png" alt="1531815482810024"></p>
<p>然后找到<code>DingDing</code>这个插件，<code>启用插件</code>，然后点击<code>Configure Plugin</code>配置插件</p>
<p><img src="/images/2018/07/1531815509278548.png" alt="1531815509278548"></p>
<p>输入刚刚获取到的<code>access_token</code>，点击<code>Save Changes</code>以保存更改</p>
<p><img src="/images/2018/07/1531815528549936.png" alt="1531815528549936"></p>
<ul>
<li>测试异常通知</li>
</ul>
<p>然后我们访问以下异常的API</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -I http://127.0.0.1:9999/error</span><br><span class="line">HTTP/1.1 500 Internal Server Error</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>此时你的钉钉机器人应该会发送如下的报错</p>
<p><img src="/images/2018/07/1531815564221066.png" alt="1531815564221066"></p>
<p>点击上面的<code>href</code>就可以跳转到错误详情页面，到此，本篇文章也就结束了。</p>

  </div>
</article>
<div style="text-align:center">
  <hr>
  <img src="/images/wechat.jpg" alt="wechat" style="width:450px;">
</div>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="//notes.ansheng.me">Notes</a></li>
         
          <li><a href="/article/python-full-stack-way/">PythonFullStackWay</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境"><span class="toc-number">1.</span> <span class="toc-text">环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化操作"><span class="toc-number">1.1.</span> <span class="toc-text">初始化操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本配置"><span class="toc-number">1.2.</span> <span class="toc-text">基本配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Docker"><span class="toc-number">2.</span> <span class="toc-text">安装Docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装docker-compose"><span class="toc-number">3.</span> <span class="toc-text">安装docker-compose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Sentry"><span class="toc-number">4.</span> <span class="toc-text">安装Sentry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentry的基本设置"><span class="toc-number">5.</span> <span class="toc-text">Sentry的基本设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#添加一个Python项目"><span class="toc-number">5.1.</span> <span class="toc-text">添加一个Python项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#测试Python程序"><span class="toc-number">5.1.1.</span> <span class="toc-text">测试Python程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看异常"><span class="toc-number">5.1.2.</span> <span class="toc-text">查看异常</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加Django项目并进行监控"><span class="toc-number">6.</span> <span class="toc-text">添加Django项目并进行监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建django项目"><span class="toc-number">6.1.</span> <span class="toc-text">创建django项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集成Sentry"><span class="toc-number">6.2.</span> <span class="toc-text">集成Sentry</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置email通知"><span class="toc-number">7.</span> <span class="toc-text">配置email通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置钉钉通知"><span class="toc-number">8.</span> <span class="toc-text">配置钉钉通知</span></a></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 ansheng
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="//notes.ansheng.me">Notes</a></li>
         
          <li><a href="/article/python-full-stack-way/">PythonFullStackWay</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-89592236-1', 'auto');
        ga('send', 'pageview');
    </script>


<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'blog-ansheng-me';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


