<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Celery是一个基于Python开发的分布式任务队列，关于Celery的更多介绍可以参考官网。 要使用Celery我们需要一个Broker和Backend，这里我们使用Redis。  GitHub官网：https://github.com/celery/celery Docs：http://docs.celeryproject.org/en/latest/ Broker：接收和发送任务消息 Ba">
<meta name="keywords" content="安生,Python">
<meta property="og:type" content="article">
<meta property="og:title" content="Celery分布式任务队列">
<meta property="og:url" content="https://blog.ansheng.me/article/celery/index.html">
<meta property="og:site_name" content="Welcome to ansheng’s blog!">
<meta property="og:description" content="Celery是一个基于Python开发的分布式任务队列，关于Celery的更多介绍可以参考官网。 要使用Celery我们需要一个Broker和Backend，这里我们使用Redis。  GitHub官网：https://github.com/celery/celery Docs：http://docs.celeryproject.org/en/latest/ Broker：接收和发送任务消息 Ba">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-07-27T03:26:40.061Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Celery分布式任务队列">
<meta name="twitter:description" content="Celery是一个基于Python开发的分布式任务队列，关于Celery的更多介绍可以参考官网。 要使用Celery我们需要一个Broker和Backend，这里我们使用Redis。  GitHub官网：https://github.com/celery/celery Docs：http://docs.celeryproject.org/en/latest/ Broker：接收和发送任务消息 Ba">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
          
        
    
    <!-- title -->
    <title>Celery分布式任务队列</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg active"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg active"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="//notes.ansheng.me">Notes</a></li>
         
          <li><a href="/article/python-full-stack-way/">PythonFullStackWay</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/article/build-your-own-mini-git-server/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/article/docker-deploy-django/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用"><span class="toc-number">2.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#应用"><span class="toc-number">2.1.</span> <span class="toc-text">应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动"><span class="toc-number">2.2.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调用任务"><span class="toc-number">2.3.</span> <span class="toc-text">调用任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#项目中使用celery"><span class="toc-number">2.4.</span> <span class="toc-text">项目中使用celery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后台运行"><span class="toc-number">2.5.</span> <span class="toc-text">后台运行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后记"><span class="toc-number">3.</span> <span class="toc-text">后记</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Celery分布式任务队列
    </h1>



    <div class="meta">
      <span class="postdate">创建日期：</span>
    <div class="postdate">
        <time datetime="2018-01-21T16:00:00.000Z" itemprop="datePublished">2018-01-22</time>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Celery是一个基于Python开发的分布式任务队列，关于Celery的更多介绍可以参考官网。</p>
<p>要使用<code>Celery</code>我们需要一个<code>Broker</code>和<code>Backend</code>，这里我们使用<code>Redis</code>。</p>
<ul>
<li>GitHub官网：<a href="https://github.com/celery/celery" target="_blank" rel="noopener">https://github.com/celery/celery</a></li>
<li>Docs：<a href="http://docs.celeryproject.org/en/latest/" target="_blank" rel="noopener">http://docs.celeryproject.org/en/latest/</a></li>
<li>Broker：接收和发送任务消息</li>
<li>Backend：存储任务执行结果</li>
</ul>
<blockquote>
<p>Celery不支持Windows</p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul>
<li>redis</li>
</ul>
<p>这里为了方便起见，我们使用<code>Docker</code>来快速启动一个<code>Redis</code>服务。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ docker pull redis</span><br><span class="line">➜  ~ docker run -d --name redis -p 6379:6379 redis</span><br></pre></td></tr></table></figure>
<ul>
<li>celery</li>
</ul>
<p>我已经通过<code>pyenv</code>创建好了一个虚拟环境，切换过去即可</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ pyenv activate venv</span><br><span class="line">(venv) ➜  ~ pip install celery</span><br></pre></td></tr></table></figure>
<p>因为我们的<code>Broker</code>和<code>Backend</code>使用的都是<code>Redis</code>，所以还需要安装<code>redis</code>模块</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ pip install redis</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>创建一个文件<code>tasks.py</code>，用来存放任务列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">'tasks'</span>, broker=<span class="string">'redis://localhost'</span>,backend=<span class="string">'redis://localhost'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>
<p><code>Celery</code>的第一个参数是这个APP的名字，<code>broker</code>和<code>backend</code>指定了要使用消息代理的URL。</p>
<p>上面我们定义了一个任务叫<code>add</code>，它返回<code>x</code>和<code>y</code>的和。</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ celery -A tasks worker --loglevel=info</span><br></pre></td></tr></table></figure>
<p>执行启动命令的时候，一定要和<code>tasks.py</code>在同一级目录下，执行成功的输出应该如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ celery -A tasks worker --loglevel=info</span><br><span class="line"></span><br><span class="line">celery@ShengdeMacBook-Pro.local v4.1.0 (latentcall)</span><br><span class="line"></span><br><span class="line">Darwin-17.3.0-x86_64-i386-64bit 2018-01-22 14:33:49</span><br><span class="line"></span><br><span class="line">[config]</span><br><span class="line">.&gt; app:         tasks:0x1069cd3c8</span><br><span class="line">.&gt; transport:   redis://localhost:6379//</span><br><span class="line">.&gt; results:     redis://localhost/</span><br><span class="line">.&gt; concurrency: 4 (prefork)</span><br><span class="line">.&gt; task events: OFF (<span class="built_in">enable</span> -E to monitor tasks <span class="keyword">in</span> this worker)</span><br><span class="line"></span><br><span class="line">[queues]</span><br><span class="line">.&gt; celery           exchange=celery(direct) key=celery</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[tasks]</span><br><span class="line">  . tasks.add</span><br><span class="line"></span><br><span class="line">[2018-01-22 14:33:49,334: INFO/MainProcess] Connected to redis://localhost:6379//</span><br><span class="line">[2018-01-22 14:33:49,350: INFO/MainProcess] mingle: searching <span class="keyword">for</span> neighbors</span><br><span class="line">[2018-01-22 14:33:50,376: INFO/MainProcess] mingle: all alone</span><br><span class="line">[2018-01-22 14:33:50,394: INFO/MainProcess] celery@ShengdeMacBook-Pro.local ready.</span><br></pre></td></tr></table></figure>
<h3 id="调用任务"><a href="#调用任务" class="headerlink" title="调用任务"></a>调用任务</h3><p>新打开一个终端并切换到虚拟环境中，然后进入Python交互模式下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> tasks <span class="keyword">import</span> add</span><br><span class="line"><span class="comment"># 如果执行函数的时候不加delay则表示当做函数来执行</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="comment"># 异步任务添加成功后返回一个AsyncResult实例</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add.delay(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">&lt;AsyncResult: e167ae38<span class="number">-0e53</span><span class="number">-4592</span>-ad0d<span class="number">-6</span>c685f16168c&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result = add.delay(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="comment"># get获取执行结果，如果任务没有执行完成就执行get则会阻塞住</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.get()</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>为了测试延迟异步效果，我们在tasks.py里面新加一个任务叫<code>sleep</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">'tasks'</span>, broker=<span class="string">'redis://localhost'</span>,backend=<span class="string">'redis://localhost'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">(t)</span>:</span></span><br><span class="line">    time.sleep(t)</span><br><span class="line">    <span class="keyword">return</span> str(time.time())</span><br></pre></td></tr></table></figure>
<p>任务添加完成之后我们需要关闭<code>celery worker</code>，然后在启动，当我们再次启动的时候回发现刚添加的任务<code>sleep</code>已经加入到tasks中了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ celery -A tasks worker --loglevel=info</span><br><span class="line"></span><br><span class="line">celery@ShengdeMacBook-Pro.local v4.1.0 (latentcall)</span><br><span class="line"></span><br><span class="line">Darwin-17.3.0-x86_64-i386-64bit 2018-01-22 14:34:27</span><br><span class="line"></span><br><span class="line">[config]</span><br><span class="line">.&gt; app:         tasks:0x105647400</span><br><span class="line">.&gt; transport:   redis://localhost:6379//</span><br><span class="line">.&gt; results:     redis://localhost/</span><br><span class="line">.&gt; concurrency: 4 (prefork)</span><br><span class="line">.&gt; task events: OFF (<span class="built_in">enable</span> -E to monitor tasks <span class="keyword">in</span> this worker)</span><br><span class="line"></span><br><span class="line">[queues]</span><br><span class="line">.&gt; celery           exchange=celery(direct) key=celery</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[tasks]</span><br><span class="line">  . tasks.add</span><br><span class="line">  . tasks.sleep</span><br><span class="line"></span><br><span class="line">[2018-01-22 14:34:27,548: INFO/MainProcess] Connected to redis://localhost:6379//</span><br><span class="line">[2018-01-22 14:34:27,563: INFO/MainProcess] mingle: searching <span class="keyword">for</span> neighbors</span><br><span class="line">[2018-01-22 14:34:28,588: INFO/MainProcess] mingle: all alone</span><br><span class="line">[2018-01-22 14:34:28,619: INFO/MainProcess] celery@ShengdeMacBook-Pro.local ready.</span><br></pre></td></tr></table></figure>
<p>再次进入python交互环境调用任务</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> tasks <span class="keyword">import</span> sleep</span><br><span class="line"><span class="comment"># 创建任务，sleep 10秒</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task = sleep.delay(<span class="number">10</span>)</span><br><span class="line"><span class="comment"># 在任务还没有执行完成的之后get结果，设置超时时间为1秒，从结果可以看出，任务并没有执行完成，抛出了一个celery.exceptions.TimeoutError的异常</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task.get(timeout=<span class="number">1</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/Users/shengan/.pyenv/versions/venv/lib/python3.6/site-packages/celery/backends/async.py"</span>, line <span class="number">256</span>, <span class="keyword">in</span> _wait_for_pending</span><br><span class="line">    on_interval=on_interval):</span><br><span class="line">  File <span class="string">"/Users/shengan/.pyenv/versions/venv/lib/python3.6/site-packages/celery/backends/async.py"</span>, line <span class="number">55</span>, <span class="keyword">in</span> drain_events_until</span><br><span class="line">    <span class="keyword">raise</span> socket.timeout()</span><br><span class="line">socket.timeout</span><br><span class="line"></span><br><span class="line">During handling of the above exception, another exception occurred:</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"/Users/shengan/.pyenv/versions/venv/lib/python3.6/site-packages/celery/result.py"</span>, line <span class="number">194</span>, <span class="keyword">in</span> get</span><br><span class="line">    on_message=on_message,</span><br><span class="line">  File <span class="string">"/Users/shengan/.pyenv/versions/venv/lib/python3.6/site-packages/celery/backends/async.py"</span>, line <span class="number">189</span>, <span class="keyword">in</span> wait_for_pending</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> self._wait_for_pending(result, **kwargs):</span><br><span class="line">  File <span class="string">"/Users/shengan/.pyenv/versions/venv/lib/python3.6/site-packages/celery/backends/async.py"</span>, line <span class="number">260</span>, <span class="keyword">in</span> _wait_for_pending</span><br><span class="line">    <span class="keyword">raise</span> TimeoutError(<span class="string">'The operation timed out.'</span>)</span><br><span class="line">celery.exceptions.TimeoutError: The operation timed out.</span><br></pre></td></tr></table></figure>
<p>如果你要想要知道一个耗时的任务有没有执行完毕，通过上述的测试可以捕获异常，然后做对应的处理，但是celery提供了一个更方便的方法。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.ready()</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.ready()</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.get()</span><br><span class="line"><span class="string">'1516603282.2424462'</span></span><br></pre></td></tr></table></figure>
<p>关于AsyncResult的结果对象可以参考：<a href="http://docs.celeryproject.org/en/latest/reference/celery.result.html" target="_blank" rel="noopener">http://docs.celeryproject.org/en/latest/reference/celery.result.html</a></p>
<h3 id="项目中使用celery"><a href="#项目中使用celery" class="headerlink" title="项目中使用celery"></a>项目中使用celery</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 项目目录</span></span><br><span class="line">(venv) ➜  ~ mkdir celery_tasks</span><br><span class="line"><span class="comment"># celery的配置文件</span></span><br><span class="line">(venv) ➜  ~ touch celery_tasks/celery.py</span><br><span class="line"><span class="comment"># 任务1</span></span><br><span class="line">(venv) ➜  ~ touch celery_tasks/task_1.py</span><br><span class="line"><span class="comment"># 任务2</span></span><br><span class="line">(venv) ➜  ~ touch celery_tasks/task_2.py</span><br></pre></td></tr></table></figure>
<ul>
<li>celery_tasks/celery.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">'celery_tasks'</span>,</span><br><span class="line">             broker=<span class="string">'redis://localhost'</span>,</span><br><span class="line">             backend=<span class="string">'redis://localhost'</span>,</span><br><span class="line">             include=[<span class="string">'celery_tasks.task_1'</span>, <span class="string">'celery_tasks.task_2'</span>])</span><br><span class="line"></span><br><span class="line">app.conf.update(</span><br><span class="line">    result_expires=<span class="number">3600</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.start()</span><br></pre></td></tr></table></figure>
<ul>
<li>celery_tasks/task_1.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">from</span> .celery <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>
<ul>
<li>celery_tasks/task_2.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> .celery <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">(t)</span>:</span></span><br><span class="line">    time.sleep(t)</span><br><span class="line">    <span class="keyword">return</span> str(time.time())</span><br></pre></td></tr></table></figure>
<ul>
<li>启动</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ celery -A celery_tasks worker -l info</span><br><span class="line"></span><br><span class="line">celery@ShengdeMacBook-Pro.local v4.1.0 (latentcall)</span><br><span class="line"></span><br><span class="line">Darwin-17.3.0-x86_64-i386-64bit 2018-01-22 14:59:33</span><br><span class="line"></span><br><span class="line">[config]</span><br><span class="line">.&gt; app:         celery_tasks:0x109e29ef0</span><br><span class="line">.&gt; transport:   redis://localhost:6379//</span><br><span class="line">.&gt; results:     redis://localhost/</span><br><span class="line">.&gt; concurrency: 4 (prefork)</span><br><span class="line">.&gt; task events: OFF (<span class="built_in">enable</span> -E to monitor tasks <span class="keyword">in</span> this worker)</span><br><span class="line"></span><br><span class="line">[queues]</span><br><span class="line">.&gt; celery           exchange=celery(direct) key=celery</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[tasks]</span><br><span class="line">  . celery_tasks.task_1.add</span><br><span class="line">  . celery_tasks.task_2.sleep</span><br><span class="line"></span><br><span class="line">[2018-01-22 14:59:34,042: INFO/MainProcess] Connected to redis://localhost:6379//</span><br><span class="line">[2018-01-22 14:59:34,072: INFO/MainProcess] mingle: searching <span class="keyword">for</span> neighbors</span><br><span class="line">[2018-01-22 14:59:35,109: INFO/MainProcess] mingle: all alone</span><br><span class="line">[2018-01-22 14:59:35,148: INFO/MainProcess] celery@ShengdeMacBook-Pro.local ready.</span><br></pre></td></tr></table></figure>
<p>新开一个窗口测试</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ python</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> celery_tasks <span class="keyword">import</span> task_1,task_2</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task_1.add.delay(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">&lt;AsyncResult: <span class="number">8621</span>cc57-ddf1<span class="number">-4188</span>-a21d<span class="number">-78678611</span>c735&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task_2.sleep.delay(<span class="number">5</span>)</span><br><span class="line">&lt;AsyncResult: a842caa1<span class="number">-3162</span><span class="number">-460</span>c-b49a<span class="number">-860797</span>f7784b&gt;</span><br></pre></td></tr></table></figure>
<h3 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h3><ul>
<li>启动</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ celery multi start celery_demo -A celery_tasks -l info</span><br><span class="line">celery multi v4.1.0 (latentcall)</span><br><span class="line">&gt; Starting nodes...</span><br><span class="line">	&gt; celery_demo@ShengdeMacBook-Pro.local: OK</span><br></pre></td></tr></table></figure>
<ul>
<li>查看进程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ ps -ef | grep celery_demo | grep -v grep</span><br><span class="line">  501 30862     1   0  3:03下午 ??         0:00.72 /Users/shengan/.pyenv/versions/3.6.3/envs/venv/bin/python -m celery worker -A celery_tasks -l info --logfile=celery_demo%I.log --pidfile=celery_demo.pid --hostname=celery_demo@ShengdeMacBook-Pro.local</span><br><span class="line">  501 30900 30862   0  3:03下午 ??         0:00.01 /Users/shengan/.pyenv/versions/3.6.3/envs/venv/bin/python -m celery worker -A celery_tasks -l info --logfile=celery_demo%I.log --pidfile=celery_demo.pid --hostname=celery_demo@ShengdeMacBook-Pro.local</span><br><span class="line">  501 30901 30862   0  3:03下午 ??         0:00.01 /Users/shengan/.pyenv/versions/3.6.3/envs/venv/bin/python -m celery worker -A celery_tasks -l info --logfile=celery_demo%I.log --pidfile=celery_demo.pid --hostname=celery_demo@ShengdeMacBook-Pro.local</span><br><span class="line">  501 30902 30862   0  3:03下午 ??         0:00.01 /Users/shengan/.pyenv/versions/3.6.3/envs/venv/bin/python -m celery worker -A celery_tasks -l info --logfile=celery_demo%I.log --pidfile=celery_demo.pid --hostname=celery_demo@ShengdeMacBook-Pro.local</span><br><span class="line">  501 30903 30862   0  3:03下午 ??         0:00.01 /Users/shengan/.pyenv/versions/3.6.3/envs/venv/bin/python -m celery worker -A celery_tasks -l info --logfile=celery_demo%I.log --pidfile=celery_demo.pid --hostname=celery_demo@ShengdeMacBook-Pro.local</span><br></pre></td></tr></table></figure>
<p>一个守护进程，<code>worker</code>个数等于<code>CPU</code>个数。</p>
<ul>
<li>重启</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ celery multi restart celery_demo -A celery_tasks -l info</span><br><span class="line">celery multi v4.1.0 (latentcall)</span><br><span class="line">&gt; Stopping nodes...</span><br><span class="line">	&gt; celery_demo@ShengdeMacBook-Pro.local: TERM -&gt; 31132</span><br><span class="line">&gt; Waiting <span class="keyword">for</span> 1 node -&gt; 31132.....</span><br><span class="line">	&gt; celery_demo@ShengdeMacBook-Pro.local: OK</span><br><span class="line">&gt; Restarting node celery_demo@ShengdeMacBook-Pro.local: OK</span><br><span class="line">&gt; Waiting <span class="keyword">for</span> 1 node -&gt; None...</span><br></pre></td></tr></table></figure>
<ul>
<li>停止</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ celery multi stop celery_demo -A celery_tasks -l info</span><br><span class="line">celery multi v4.1.0 (latentcall)</span><br><span class="line">&gt; Stopping nodes...</span><br><span class="line">	&gt; celery_demo@ShengdeMacBook-Pro.local: TERM -&gt; 30862</span><br></pre></td></tr></table></figure>
<ul>
<li>等待任务执行完毕后停止</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) ➜  ~ celery multi stopwait celery_demo -A celery_tasks -l info</span><br></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p><code>Celery</code>不仅可以做异步任务，还可以做<a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html" target="_blank" rel="noopener">定时任务</a>，它还与<code>django</code>做了深度结合，可以使用<a href="https://github.com/celery/django-celery-results" target="_blank" rel="noopener">django-celery-result</a>库将任务执行的结果存放到django的models中，<a href="https://github.com/celery/django-celery-beat" target="_blank" rel="noopener">django-celery-beat</a>库会将定时任务的规则存入到数据库中，而不用通过配置文件来定义。</p>

  </div>
</article>
<div style="text-align:center">
  <hr>
  <img src="/images/wechat.jpg" alt="wechat" style="width:450px;">
</div>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="//notes.ansheng.me">Notes</a></li>
         
          <li><a href="/article/python-full-stack-way/">PythonFullStackWay</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用"><span class="toc-number">2.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#应用"><span class="toc-number">2.1.</span> <span class="toc-text">应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动"><span class="toc-number">2.2.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调用任务"><span class="toc-number">2.3.</span> <span class="toc-text">调用任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#项目中使用celery"><span class="toc-number">2.4.</span> <span class="toc-text">项目中使用celery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后台运行"><span class="toc-number">2.5.</span> <span class="toc-text">后台运行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后记"><span class="toc-number">3.</span> <span class="toc-text">后记</span></a></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 ansheng
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="//notes.ansheng.me">Notes</a></li>
         
          <li><a href="/article/python-full-stack-way/">PythonFullStackWay</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-89592236-1', 'auto');
        ga('send', 'pageview');
    </script>


<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'blog-ansheng-me';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


