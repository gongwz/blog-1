<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="SupervisorSupervisor是使用Python开发的一款进程管理工具，不能在Windows上运行，至少现在是不可以，它主要是在类UNIX上管理进程，当然，它主要管理的是前台进程而不是后台进程， 主要应用场景如一个进程需要对外提供服务并且要一直运行着，但是由于一些未知的因素进程挂掉了，这个时候如果这个进程被Supervisor所管理，那么当进程挂掉的时候，Supervisor就会自动启动">
<meta name="keywords" content="安生,Python">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx结合Supervisor部署Tornado">
<meta property="og:url" content="https://blog.ansheng.me/article/nginx-deployed-tornado-with-supervisor/index.html">
<meta property="og:site_name" content="Welcome to ansheng’s blog!">
<meta property="og:description" content="SupervisorSupervisor是使用Python开发的一款进程管理工具，不能在Windows上运行，至少现在是不可以，它主要是在类UNIX上管理进程，当然，它主要管理的是前台进程而不是后台进程， 主要应用场景如一个进程需要对外提供服务并且要一直运行着，但是由于一些未知的因素进程挂掉了，这个时候如果这个进程被Supervisor所管理，那么当进程挂掉的时候，Supervisor就会自动启动">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-07-27T03:26:40.068Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nginx结合Supervisor部署Tornado">
<meta name="twitter:description" content="SupervisorSupervisor是使用Python开发的一款进程管理工具，不能在Windows上运行，至少现在是不可以，它主要是在类UNIX上管理进程，当然，它主要管理的是前台进程而不是后台进程， 主要应用场景如一个进程需要对外提供服务并且要一直运行着，但是由于一些未知的因素进程挂掉了，这个时候如果这个进程被Supervisor所管理，那么当进程挂掉的时候，Supervisor就会自动启动">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
          
        
    
    <!-- title -->
    <title>Nginx结合Supervisor部署Tornado</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg active"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg active"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="//notes.ansheng.me">Notes</a></li>
         
          <li><a href="/article/python-full-stack-way/">PythonFullStackWay</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/article/tcp-ip-three-handshakes-and-four-waving/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/article/through-the-browser-to-access-a-site-behind-what-has-gone-through/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Supervisor"><span class="toc-number">1.</span> <span class="toc-text">Supervisor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置Nginx"><span class="toc-number">2.</span> <span class="toc-text">配置Nginx</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Nginx结合Supervisor部署Tornado
    </h1>



    <div class="meta">
      <span class="postdate">创建日期：</span>
    <div class="postdate">
        <time datetime="2017-05-23T16:00:00.000Z" itemprop="datePublished">2017-05-24</time>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="Supervisor"><a href="#Supervisor" class="headerlink" title="Supervisor"></a>Supervisor</h3><p><code>Supervisor</code>是使用Python开发的一款进程管理工具，不能在<code>Windows</code>上运行，至少现在是不可以，它主要是在类UNIX上管理进程，当然，它主要管理的是前台进程而不是后台进程，</p>
<p>主要应用场景如一个进程需要对外提供服务并且要一直运行着，但是由于一些未知的因素进程挂掉了，这个时候如果这个进程被<code>Supervisor</code>所管理，那么当进程挂掉的时候，<code>Supervisor</code>就会自动启动它，继续对外提供服务，否则进程挂掉了就需要我们手动启动了。</p>
<p>操作系统环境如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.3.1611 (Core) </span><br><span class="line">[root@localhost ~]<span class="comment"># uname -a</span></span><br><span class="line">Linux localhost.localdomain 3.10.0-514.2.2.el7.x86_64 <span class="comment">#1 SMP Tue Dec 6 23:06:41 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /proc/cpuinfo | grep "processor"</span></span><br><span class="line">processor	: 0</span><br></pre></td></tr></table></figure>
<p>安装Supervisor</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># yum -y install supervisor</span></span><br></pre></td></tr></table></figure>
<p>生成配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># tail -2 /etc/supervisord.conf </span></span><br><span class="line">[include]</span><br><span class="line"><span class="comment"># 这里是说只要这个目录下面以.ini结尾的文件都会被supervisor加载</span></span><br><span class="line">files = supervisord.d/*.ini</span><br></pre></td></tr></table></figure>
<p>创建<code>tornado</code>进程配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/supervisord.d/tornados.ini</span></span><br><span class="line"><span class="comment"># 为了方便管理，增加一个tornado组</span></span><br><span class="line">[group:tornados]</span><br><span class="line">programs=tornado-0,tornado-1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分别定义三个tornado的进程配置</span></span><br><span class="line">[program:tornado-0]</span><br><span class="line"><span class="comment"># 进程要执行的命令</span></span><br><span class="line"><span class="built_in">command</span>=python /root/tornado/hello.py --port=8000</span><br><span class="line">directory=/root/tornado/</span><br><span class="line">user=root</span><br><span class="line"><span class="comment"># 自动重启</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">redirect_stderr=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 日志路径</span></span><br><span class="line">stdout_logfile=/root/tornado/tornado0.log</span><br><span class="line">loglevel=info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[program:tornado-1]</span><br><span class="line"><span class="built_in">command</span>=python /root/tornado/hello.py --port=8001</span><br><span class="line">directory=/root/tornado/</span><br><span class="line">user=root</span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">redirect_stderr=<span class="literal">true</span></span><br><span class="line">stdout_logfile=/root/tornado/tornado1.log</span><br><span class="line">loglevel=info</span><br></pre></td></tr></table></figure>
<p>创建<code>tornado</code>启动程序</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mkdir tornado</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cd tornado/</span></span><br><span class="line">[root@localhost tornado]<span class="comment"># vim hello.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># _*_coding:utf-8 _*_</span></span><br><span class="line"></span><br><span class="line">import tornado.ioloop</span><br><span class="line">import tornado.web</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">PORT = sys.argv[1]</span><br><span class="line"></span><br><span class="line">class MainHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        self.write(PORT)</span><br><span class="line"></span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (r<span class="string">'/'</span>, MainHandler),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    application.listen(PORT)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure>
<p>启动试试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tornado]<span class="comment"># python3.4 hello.py 8000</span></span><br></pre></td></tr></table></figure>
<p>打开另一个<code>shell</code>窗口<code>curl</code>下看看有没有返回值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># curl 127.0.0.1:8000</span></span><br><span class="line"><span class="comment"># 有返回启动时指定的端口代表tornado没问题</span></span><br><span class="line">8000</span><br></pre></td></tr></table></figure>
<p>创建<code>www</code>用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tornado]<span class="comment"># useradd -s /sbin/nologin -M www</span></span><br></pre></td></tr></table></figure>
<p>启动Supervisor</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动的时候需要指定配置文件</span></span><br><span class="line">[root@localhost tornado]<span class="comment"># supervisord -c /etc/supervisord.conf</span></span><br></pre></td></tr></table></figure>
<p>验证启动是否成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 看进程</span></span><br><span class="line">[root@localhost tornado]<span class="comment"># ps -ef | grep "supervisord" | grep -v "grep"</span></span><br><span class="line">root       1151      1  0 15:50 ?        00:00:00 /usr/bin/python /usr/bin/supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>访问<code>tornado</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tornado]<span class="comment"># curl 127.0.0.1:8000</span></span><br><span class="line">8000</span><br><span class="line">[root@localhost tornado]<span class="comment"># curl 127.0.0.1:8001</span></span><br><span class="line">8001</span><br></pre></td></tr></table></figure>
<h3 id="配置Nginx"><a href="#配置Nginx" class="headerlink" title="配置Nginx"></a>配置Nginx</h3><p>先安装<code>Nginx</code>，我这里的配置就简单点，一路往下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost tornado]<span class="comment"># cd ../</span></span><br><span class="line"><span class="comment"># 安装编译Nginx所依赖的包</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum -y install pcre pcre-devel zlib zlib-devel</span></span><br></pre></td></tr></table></figure>
<p>编译安装Nginx<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># wget http://nginx.org/download/nginx-1.10.2.tar.gz</span></span><br><span class="line">[root@localhost ~]<span class="comment"># tar xf nginx-1.10.2.tar.gz </span></span><br><span class="line">[root@localhost ~]<span class="comment"># cd nginx-1.10.2</span></span><br><span class="line">[root@localhost nginx-1.10.2]<span class="comment"># ./configure \</span></span><br><span class="line">--prefix=/etc/nginx \</span><br><span class="line">--sbin-path=/usr/sbin/nginx \</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx</span><br><span class="line">[root@localhost nginx-1.10.2]<span class="comment"># make</span></span><br><span class="line">[root@localhost nginx-1.10.2]<span class="comment"># make install</span></span><br></pre></td></tr></table></figure></p>
<p>编辑Nginx配置文件<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost nginx-1.10.2]# cd /etc/nginx/</span><br><span class="line">[root@localhost nginx]# vim nginx.conf</span><br><span class="line">user  www;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    upstream tornados&#123;</span><br><span class="line">        server 127.0.0.1:8000;</span><br><span class="line">        server 127.0.0.1:8001;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass_header Server;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        # 把请求方向代理传给tornado服务器，负载均衡</span><br><span class="line">        proxy_pass http://tornados;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>检测与法是否有错误<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost nginx]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br></pre></td></tr></table></figure></p>
<p>启动Nginx<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost nginx]# nginx </span><br><span class="line"># 查看启动状态</span><br><span class="line">[root@localhost nginx]# netstat -tlnp | grep &quot;80&quot;</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      6011/nginx: master</span><br></pre></td></tr></table></figure></p>
<p>访问80端口，这个时候发现已经打通了，nginx的调度算法也是轮训的。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost nginx]# curl 127.0.0.1</span><br><span class="line">8000</span><br><span class="line">[root@localhost nginx]# curl 127.0.0.1</span><br><span class="line">8001</span><br><span class="line">[root@localhost nginx]# curl 127.0.0.1</span><br><span class="line">8000</span><br><span class="line">[root@localhost nginx]# curl 127.0.0.1</span><br><span class="line">8001</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>先写这么多吧，冻死了，配置文件什么的都比较少，这个要根据具体业务具体优化的，特别是nginx，这个要问问运维的同学了。。</p>

  </div>
</article>
<div style="text-align:center">
  <hr>
  <img src="/images/wechat.jpg" alt="wechat" style="width:450px;">
</div>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="//notes.ansheng.me">Notes</a></li>
         
          <li><a href="/article/python-full-stack-way/">PythonFullStackWay</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Supervisor"><span class="toc-number">1.</span> <span class="toc-text">Supervisor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置Nginx"><span class="toc-number">2.</span> <span class="toc-text">配置Nginx</span></a></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 ansheng
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="//notes.ansheng.me">Notes</a></li>
         
          <li><a href="/article/python-full-stack-way/">PythonFullStackWay</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-89592236-1', 'auto');
        ga('send', 'pageview');
    </script>


<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'blog-ansheng-me';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


